name: Helm Test
on:
  push:
    tags:
      - v*
    branches:
      - master
  pull_request:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Kubernetes KinD Cluster
        uses: container-tools/kind-action@v2

      - name: Build and push Docker image
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4
        with:
          context: .
          file: ./build/full/Dockerfile
          push: true
          tags: localhost:5000/flanksource/canary-checker:latest
          cache-from: type=registry,ref=docker.io/flanksource/canary-checker

      - name: Update canary-checker image in helm chart
        uses: mikefarah/yq@master
        with:
          cmd: yq -i e '.global.imageRegistry = "kind-registry:5000"' chart/values.yaml

      - name: Setup Helm
        uses: azure/setup-helm@b9e51907a09c216f16ebe8536097933489208112 # v4.3.0
        with:
          version: v3.11.3

      - name: Package helm chart
        run: |
          helm dependency build ./chart
          helm package ./chart --version 1.0.0

      - name: Install helm chart
        run: "helm install canary-checker canary-checker-1.0.0.tgz -n canary-checker --create-namespace"

      - name: Wait for 30 seconds
        run: "kubectl rollout status deploy/canary-checker -n canary-checker --timeout 5m"

      - name: Check canary-checker pods
        run: "kubectl describe pods -n canary-checker"

      - name: Run tests
        run: ./chart/test.sh canary-checker

      - name: Check logs
        run: kubectl logs deploy/canary-checker -n canary-checker
        if: always()
